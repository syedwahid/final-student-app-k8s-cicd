name: Deploy Student App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup GCP Authentication
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
    
    - name: Deploy Infrastructure
      working-directory: ./terraform/gcp
      run: |
        # Initialize Terraform
        terraform init
        
        # Create terraform.tfvars with ALL variables
        cat > terraform.tfvars << 'EOF'
        gcp_project = "student-app-1765219404"
        gcp_region  = "us-central1"
        gcp_zone    = "us-central1-a"
        vm_name     = "student-app-vm"
        vm_type     = "e2-medium"
        vm_image    = "ubuntu-2204-lts"
        disk_size   = 20
        EOF
        
        echo "âœ… Configuration created"
        cat terraform.tfvars
        
        # Clean up existing resources first
        echo "ðŸ§¹ Cleaning up existing resources..."
        terraform destroy -auto-approve || echo "No existing resources to destroy or destroy failed, continuing..."
        
        # Apply new infrastructure
        echo "ðŸš€ Applying Terraform..."
        terraform apply -auto-approve
    
    - name: Display Results
      working-directory: ./terraform/gcp
      run: |
        echo "## ðŸŽ‰ Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Try to get IP
        if terraform output vm_public_ip >/dev/null 2>&1; then
          VM_IP=$(terraform output -raw vm_public_ip)
          echo "**âœ… VM IP:** $VM_IP" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŒ Frontend:** http://$VM_IP:31349" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”— Backend:** http://$VM_IP:30001/api/health" >> $GITHUB_STEP_SUMMARY
        else
          echo "**â„¹ï¸ Status:** Infrastructure deployment completed" >> $GITHUB_STEP_SUMMARY
          echo "Check GCP Console for VM details." >> $GITHUB_STEP_SUMMARY
        fi