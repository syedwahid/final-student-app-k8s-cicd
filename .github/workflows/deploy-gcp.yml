name: Deploy Student App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup GCP Authentication
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
    
    - name: Deploy Infrastructure
      working-directory: ./terraform/gcp
      run: |
        # Initialize Terraform
        terraform init
        
        # Create terraform.tfvars with ALL variables
        cat > terraform.tfvars << 'EOF'
        gcp_project = "student-app-1765219404"
        gcp_region  = "us-central1"
        gcp_zone    = "us-central1-a"
        vm_name     = "student-app-vm"
        vm_type     = "e2-medium"
        vm_image    = "ubuntu-2204-lts"
        disk_size   = 20
        EOF
        
        echo "âœ… Configuration created"
        cat terraform.tfvars
        
        # First, import existing resources to state if they exist
        echo "ðŸ”„ Checking for existing resources..."
        
        # Try to destroy first (this will fail if state is empty)
        terraform destroy -auto-approve || true
        
        # If destroy failed due to missing state, use gcloud CLI to delete resources directly
        echo "ðŸ§¹ Forcing removal of conflicting resources via gcloud..."
        
        # Delete firewall rule if exists
        gcloud compute firewall-rules delete allow-student-app-ports --quiet --project=student-app-1765219404 2>/dev/null || echo "Firewall rule not found or already deleted"
        
        # Delete static IP if exists
        gcloud compute addresses delete student-app-vm-ip --region=us-central1 --quiet --project=student-app-1765219404 2>/dev/null || echo "Static IP not found or already deleted"
        
        # Delete VM if exists
        gcloud compute instances delete student-app-vm --zone=us-central1-a --quiet --project=student-app-1765219404 2>/dev/null || echo "VM not found or already deleted"
        
        # Wait a moment for resources to be fully deleted
        sleep 10
        
        # Initialize fresh state
        echo "ðŸ”„ Re-initializing Terraform..."
        terraform init -reconfigure
        
        # Apply new infrastructure
        echo "ðŸš€ Applying Terraform..."
        terraform apply -auto-approve
    
    - name: Display Results
      working-directory: ./terraform/gcp
      run: |
        echo "## ðŸŽ‰ Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Try to get IP
        if terraform output vm_public_ip >/dev/null 2>&1; then
          VM_IP=$(terraform output -raw vm_public_ip)
          echo "**âœ… VM IP:** $VM_IP" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŒ Frontend:** http://$VM_IP:31349" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”— Backend:** http://$VM_IP:30001/api/health" >> $GITHUB_STEP_SUMMARY
        else
          echo "**â„¹ï¸ Status:** Infrastructure deployment completed" >> $GITHUB_STEP_SUMMARY
          echo "Check GCP Console for VM details." >> $GITHUB_STEP_SUMMARY
        fi