name: Deploy Student App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Auth to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
    
    - name: Enable APIs
      run: |
        gcloud services enable compute.googleapis.com \
          cloudresourcemanager.googleapis.com \
          --project="student-app-1765219404" --quiet
        sleep 30
    
    - name: Deploy VM
      working-directory: ./terraform/gcp
      run: |
        terraform init
        
        # Deploy without SSH key
        terraform apply -auto-approve \
          -var="gcp_project=student-app-1765219404" \
          -var="gcp_region=us-central1" \
          -var="gcp_zone=us-central1-a" \
          -var="vm_name=student-app-vm"
        
        echo "âœ… VM deployed at: $(terraform output -raw vm_public_ip)"
        echo "ğŸŒ Frontend: http://$(terraform output -raw vm_public_ip):31349"
        echo "ğŸ”— Backend: http://$(terraform output -raw vm_public_ip):30001/api/health"